# ğŸ”§ CorreÃ§Ã£o URGENTE do Fluxo N8N - Upload de Documentos

## ğŸš¨ **Problema CrÃ­tico Identificado**

O fluxo N8N estava criando **151 registros** em `documents_details` (um por chunk) quando deveria criar **apenas 1 registro por documento**.

**Estado Atual**: N8N cria registros mas nÃ£o salva `content` e `summary`
**Resultado**: Preview mostra arquivo "vazio" com poucos caracteres

## âœ… **Estrutura Correta**

### **`documents_details` (1 registro por documento)**
```sql
- id: UUID Ãºnico do documento
- chatbot_user: UUID do usuÃ¡rio  
- filename: Nome original do arquivo (NÃƒO timestamp)
- content: ConteÃºdo completo do arquivo           -- âš ï¸ OBRIGATÃ“RIO
- summary: Resumo das primeiras 50 palavras      -- âš ï¸ OBRIGATÃ“RIO
- file_size: Tamanho em bytes
- upload_date: Data do upload
- status: 'processing' -> 'completed'
- chatbot_name: Nome do chatbot
- file_type: Tipo MIME do arquivo
```

### **`documents` (N registros por chunk)**
```sql
- id: ID sequencial do chunk
- chatbot_user: UUID do usuÃ¡rio
- content: Texto do chunk (pedaÃ§o do documento)
- metadata: JSON com referÃªncias ao arquivo
- embedding: Vetor de embeddings do chunk
```

## ğŸ”„ **Fluxo Correto N8N**

### **1. ğŸ“¥ Receber Upload**
```javascript
// Payload recebido via FormData
const formData = {
  data: file,           // Arquivo binÃ¡rio
  chatbot: "Dolesc",
  userid: "uuid-do-usuario",
  filename: "documento.txt",
  filesize: "1024",
  filetype: "text/plain"
};
```

### **2. ğŸ“ Processar Arquivo**
```javascript
// Ler conteÃºdo completo
const fileContent = $input.binary.data.toString('utf8');
const documentId = uuidv4();

// Gerar summary
function generateSummary(content) {
  const cleanContent = content.replace(/\s+/g, " ").trim();
  const words = cleanContent.split(" ").slice(0, 50);
  let summary = words.join(" ");
  if (cleanContent.split(" ").length > 50) {
    summary += "...";
  }
  return summary || "Resumo nÃ£o disponÃ­vel";
}

const summary = generateSummary(fileContent);
```

### **3. ğŸ’¾ Criar UM Registro em `documents_details`**
```sql
-- IMPORTANTE: APENAS 1 REGISTRO POR DOCUMENTO
INSERT INTO documents_details (
  id,
  chatbot_user,
  filename,
  content,           -- âš ï¸ SALVAR CONTEÃšDO COMPLETO
  summary,           -- âš ï¸ SALVAR RESUMO GERADO
  file_size,
  upload_date,
  status,
  chatbot_name,
  file_type
) VALUES (
  $documentId,       -- UUID Ãºnico
  $userid,
  $filename,         -- Nome original (nÃ£o timestamp)
  $fileContent,      -- TEXTO COMPLETO DO ARQUIVO
  $summary,          -- RESUMO DAS PRIMEIRAS 50 PALAVRAS
  $filesize,
  NOW(),
  'processing',      -- Iniciar como processing
  $chatbot,
  $filetype
);
```

### **4. ğŸ§© Criar Chunks em `documents`**
```javascript
// Dividir em chunks
function createChunks(content, chunkSize = 1000) {
  const chunks = [];
  for (let i = 0; i < content.length; i += chunkSize) {
    chunks.push(content.substring(i, i + chunkSize));
  }
  return chunks;
}

const chunks = createChunks(fileContent);

// Para cada chunk: inserir APENAS em documents (NÃƒO em documents_details)
chunks.forEach(async (chunk, index) => {
  const embedding = await generateEmbedding(chunk);
  
  await supabase
    .from('documents')
    .insert({
      chatbot_user: userid,
      content: chunk,
      metadata: {
        filename: filename,
        chatbot_user: userid,
        file_name: filename,
        usuario: userid,
        chunk_index: index,
        total_chunks: chunks.length,
        document_id: documentId  // ReferÃªncia ao documento principal
      },
      embedding: embedding
    });
});
```

### **5. âœ… Finalizar Documento**
```sql
-- Atualizar o MESMO registro para completed
UPDATE documents_details 
SET status = 'completed'
WHERE id = $documentId;
```

### **6. ğŸ“Š Resposta Final**
```json
{
  "success": true,
  "documentId": "uuid-do-documento",
  "filename": "documento.txt",
  "contentLength": 1524,
  "summaryLength": 89,
  "chunksCreated": 2,
  "message": "Documento processado com sucesso"
}
```

## ğŸ§ª **ValidaÃ§Ã£o com Script de Teste**

Use o script atualizado `debug-preview-webhook.js` que verifica especificamente:

### **Antes da CorreÃ§Ã£o**
```
ğŸ“Š ESTATÃSTICAS:
ğŸ“„ Total de documentos: 4
âœ… Com content vÃ¡lido: 0 (0%)
âœ… Com summary vÃ¡lido: 0 (0%)
âŒ PROBLEMA: N8N nÃ£o estÃ¡ salvando content corretamente!
âŒ PROBLEMA: N8N nÃ£o estÃ¡ gerando summary!
```

### **ApÃ³s a CorreÃ§Ã£o**
```
ğŸ“Š ESTATÃSTICAS:
ğŸ“„ Total de documentos: 4
âœ… Com content vÃ¡lido: 4 (100%)
âœ… Com summary vÃ¡lido: 4 (100%)
ğŸ‰ N8N funcionando perfeitamente!
```

## âœ… **Checklist de CorreÃ§Ã£o**

- [ ] **Criar apenas 1 registro** em `documents_details` por documento
- [ ] **Salvar content completo** em `documents_details.content`
- [ ] **Gerar e salvar summary** em `documents_details.summary`
- [ ] **Criar mÃºltiplos chunks** apenas em `documents`
- [ ] **Usar filename original** (nÃ£o timestamp)
- [ ] **Status: processing â†’ completed**
- [ ] **Preview funciona** sem mostrar "null"

---

**ğŸ¯ Esta correÃ§Ã£o resolverÃ¡ definitivamente o problema do preview "null"!**
